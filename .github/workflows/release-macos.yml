name: Build and Release (macOS)

on:
  # Allow manual trigger
  workflow_dispatch:

  # Trigger on tag push
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write  # Required for creating releases

jobs:
  build-macos:
    name: Build macOS executable
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Build executable
        run: python build_executable.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pensieve-macos
          path: |
            dist/pensieve-*-macos
            dist/pensieve-*-macos.sha256
          retention-days: 90

      - name: Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/pensieve-*-macos
            dist/pensieve-*-macos.sha256
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Formula
        if: startsWith(github.ref, 'refs/tags/')
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          RAW_REF: ${{ github.ref }}
        run: |
          # Skip if token not configured
          if [ -z "$HOMEBREW_TAP_TOKEN" ]; then
            echo "HOMEBREW_TAP_TOKEN not set - skipping formula update"
            echo "To enable automatic formula updates, add HOMEBREW_TAP_TOKEN secret"
            exit 0
          fi

          # Extract and validate version (must be semver format)
          VERSION="${RAW_REF#refs/tags/v}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Invalid version format: $VERSION"
            exit 1
          fi

          # Read SHA256 from the checksum file we created
          CHECKSUM_FILE="dist/pensieve-${VERSION}-macos.sha256"
          if [ ! -f "$CHECKSUM_FILE" ]; then
            echo "ERROR: Checksum file not found: $CHECKSUM_FILE"
            exit 1
          fi
          SHA256=$(cut -d' ' -f1 < "$CHECKSUM_FILE")

          echo "Updating Homebrew formula to v${VERSION} with SHA256: ${SHA256}"

          # Clone the tap repo
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/pradeeproark/homebrew-pensieve.git" tap
          cd tap

          # Update version, url, and sha256 in the formula
          # Note: bin.install uses #{version} interpolation, so no update needed there
          sed -i '' "s/version \"[^\"]*\"/version \"${VERSION}\"/" Formula/pensieve.rb
          sed -i '' "s|url \"[^\"]*\"|url \"https://github.com/pradeeproark/pensieve/releases/download/v${VERSION}/pensieve-${VERSION}-macos\"|" Formula/pensieve.rb
          sed -i '' "s/sha256 \"[^\"]*\"/sha256 \"${SHA256}\"/" Formula/pensieve.rb

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/pensieve.rb
          git diff --staged --quiet || git commit -m "Update pensieve to v${VERSION}"
          git push
